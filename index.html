<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel ‚Ä¢ 2012‚Äì2024 (Valores e CV) ‚Äî Indicadores Mercado de Trabalho (IBGE)</title>

  <!-- Plotly + PapaParse + html2pdf -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --azul-escuro:#002b5c;
      --cinza-fundo:#f5f6fa;
      --borda:#dcdfe6;
      --texto:#222;
      --muted:#666;
      --card:#fff;
    }
    body{
      margin:0;
      background:var(--cinza-fundo);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--texto);
    }
    header{
      background:var(--azul-escuro);
      color:#fff;
      padding:16px 24px;
      text-align:center;
      font-size:1.05rem;
      font-weight:800;
      letter-spacing:.02em;
    }
    main{
      max-width:1400px;
      margin:24px auto 64px auto;
      padding:0 16px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .card{
      background:var(--card);
      border-radius:12px;
      border:1px solid var(--borda);
      box-shadow:0 8px 24px rgba(0,0,0,.04);
      padding:16px 18px 18px 18px;
    }
    .titulo-bloco{
      font-size:1rem;
      font-weight:800;
      color:var(--azul-escuro);
      margin:0 0 8px 0;
      line-height:1.3;
      text-align:center;
    }
    .sub-bloco{
      font-size:.82rem;
      font-weight:400;
      color:#555;
      text-align:center;
      margin-top:-2px;
      margin-bottom:14px;
      line-height:1.4;
    }

    .tabs{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .tabbtn{
      border:1px solid var(--borda);
      background:#fff;
      color:#222;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:.85rem;
      font-weight:750;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .tabbtn.ativo{
      background:var(--azul-escuro);
      border-color:var(--azul-escuro);
      color:#fff;
    }

    #filtros{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      justify-content:center;
      align-items:flex-end;
    }
    .filtro-group{
      display:flex;
      flex-direction:column;
      font-size:.8rem;
      color:#444;
      min-width:220px;
    }
    .filtro-group label{
      font-weight:750;
      margin-bottom:4px;
    }
    select, input[type="file"]{
      background:#fff;
      border:1px solid var(--borda);
      border-radius:10px;
      padding:9px 10px;
      font-size:.85rem;
      color:#222;
      outline:none;
    }

    .linha-acoes{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      align-items:center;
      margin-top:10px;
    }
    .btn{
      border:1px solid var(--borda);
      background:#fff;
      padding:9px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:.85rem;
      font-weight:750;
      user-select:none;
    }
    .btn:hover{ background:#f0f3f9; }
    .btn.primary{
      background:var(--azul-escuro);
      border-color:var(--azul-escuro);
      color:#fff;
    }
    .btn.primary:hover{ filter:brightness(.95); }
    .status{
      font-size:.78rem;
      color:var(--muted);
      text-align:center;
      margin-top:8px;
    }

    #viz-wrapper{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:stretch;
    }
    #grafico-wrapper{
      flex:1;
      min-width:320px;
    }
    #grafico{
      width:100%;
      min-height:520px;
    }

    #painel-governos-wrapper{
      width:270px;
      min-width:270px;
      border-left:1px solid var(--borda);
      padding-left:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    #painel-governos-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    #painel-governos-header span{
      font-size:.82rem;
      font-weight:900;
      color:#333;
    }
    #reset-governo{
      font-size:.72rem;
      background:#fff;
      border:1px solid var(--borda);
      border-radius:8px;
      padding:6px 8px;
      cursor:pointer;
      line-height:1.1;
      display:none;
    }
    #reset-governo:hover{ background:#f0f0f0; }

    #painel-governos{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .gov-item{
      border-radius:10px;
      padding:9px 10px;
      font-size:.78rem;
      line-height:1.25;
      color:#fff;
      font-weight:850;
      cursor:pointer;
      border:2px solid transparent;
      user-select:none;
    }
    .gov-sub{
      opacity:.95;
      font-weight:650;
      font-size:.72rem;
      margin-top:2px;
    }
    .gov-item.ativo{
      border-color:#000;
      box-shadow:0 0 0 2px #000 inset;
    }

    #tabela-wrapper{
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:900px;
      font-size:.82rem;
    }
    thead th{
      background:var(--azul-escuro);
      color:#fff;
      font-weight:900;
      text-align:center;
      padding:9px 7px;
      white-space:nowrap;
    }
    tbody td{
      text-align:center;
      padding:9px 7px;
      border-bottom:1px solid var(--borda);
      background:#fff;
      color:#333;
    }
    tbody tr:hover td{ background:#f9fbff; }

    footer{
      text-align:center;
      font-size:.74rem;
      color:#666;
      padding:26px 14px 30px 14px;
    }
    footer a{ color:#1f77b4; text-decoration:none; }
    footer a:hover{ text-decoration:underline; }

    @media(max-width:980px){
      #viz-wrapper{ flex-direction:column; }
      #painel-governos-wrapper{
        width:100%;
        min-width:auto;
        border-left:none;
        border-top:1px solid var(--borda);
        padding-left:0;
        padding-top:12px;
      }
    }
  </style>
</head>

<body>
<header>üìä Painel Interativo ‚Ä¢ Indicadores do Mercado de Trabalho (IBGE)</header>

<main id="dashboardRoot">

  <section class="card">
    <h2 class="titulo-bloco">Painel ‚Ä¢ 2012‚Äì2024 (Valores e Coeficiente de Varia√ß√£o)</h2>
    <div class="sub-bloco">Filtros por localidade e vari√°vel + leitura por governo (m√©dia, tend√™ncia e varia√ß√µes).</div>

    <div class="tabs">
      <button class="tabbtn ativo" id="tabValores" title="S√©rie de valores">üìå Valores</button>
      <button class="tabbtn" id="tabCV" title="Coeficiente de varia√ß√£o">üìé CV</button>
    </div>

    <div id="filtros">
      <div class="filtro-group">
        <label for="selLocalidade">Localidade</label>
        <select id="selLocalidade"></select>
      </div>

      <div class="filtro-group">
        <label for="selVariavel">Vari√°vel</label>
        <select id="selVariavel"></select>
      </div>

      <div class="filtro-group">
        <label for="selAnoMin">Ano (min/max)</label>
        <div style="display:flex; gap:10px;">
          <select id="selAnoMin" style="flex:1;"></select>
          <select id="selAnoMax" style="flex:1;"></select>
        </div>
      </div>

      <div class="filtro-group">
        <label>Carregar dados (opcional)</label>
        <input type="file" id="fileValores" accept=".csv,text/csv" />
        <div style="height:8px;"></div>
        <input type="file" id="fileCV" accept=".csv,text/csv" />
        <div style="font-size:.72rem;color:#666;margin-top:6px;">
          Se estiver no GitHub, pode ignorar (usa /data/*.csv).
        </div>
      </div>
    </div>

    <div class="linha-acoes">
      <button class="btn primary" id="btnAplicar">Aplicar</button>
      <button class="btn" id="btnReset">Reset</button>

      <button class="btn" id="btnDownRecorte">Baixar CSV (recorte)</button>
      <button class="btn" id="btnDownTabela">Baixar CSV (tabela governos)</button>
      <button class="btn" id="btnDownPNG">Baixar PNG (gr√°fico)</button>
      <button class="btn" id="btnDownPDF">Exportar PDF</button>
    </div>

    <div class="status" id="statusText">Carregando dados‚Ä¶</div>
  </section>

  <section class="card">
    <div id="viz-wrapper">
      <div id="grafico-wrapper">
        <div id="grafico"></div>
      </div>

      <aside id="painel-governos-wrapper">
        <div id="painel-governos-header">
          <span>Governos (clique para filtrar)</span>
          <button id="reset-governo" title="Voltar para todos os governos">Mostrar todos</button>
        </div>
        <div id="painel-governos"></div>
      </aside>
    </div>
  </section>

  <section class="card">
    <h2 class="titulo-bloco">üìà Estat√≠sticas por governo</h2>
    <div class="sub-bloco">
      M√©dia, m√≠nimo, m√°ximo, varia√ß√£o interna e varia√ß√£o em rela√ß√£o ao governo anterior (no recorte selecionado).
    </div>

    <div id="tabela-wrapper">
      <table id="tabela-estat">
        <thead>
          <tr>
            <th>Governo</th>
            <th>In√≠cio</th>
            <th>Fim</th>
            <th>N (anos)</th>
            <th>M√©dia</th>
            <th>M√≠nimo</th>
            <th>M√°ximo</th>
            <th>Varia√ß√£o interna (%)</th>
            <th>Œî M√©dia vs. anterior (%)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</main>

<footer>
  Fonte: IBGE ‚Äî S√≠ntese de Indicadores Sociais, 2025. Dispon√≠vel em:
  <a href="https://www.ibge.gov.br/estatisticas/sociais/trabalho/9221-sintese-de-indicadores-sociais.html?=&t=resultados" target="_blank" rel="noopener noreferrer">
    p√°gina do IBGE
  </a>.
  <br/>
  Painel explorat√≥rio ‚Ä¢ C√°lculos e visualiza√ß√£o: Lucas Cunha ‚Ä¢ <span id="data-atualizacao"></span>
</footer>

<script>
/* =========================
   CONFIG
========================= */
const PATH_VALORES_DEFAULT = "data/painel_valores.csv";
const PATH_CV_DEFAULT      = "data/painel_cv.csv";

const COL_ANO = "Ano";
const COL_LOC = "Grandes Regi√µes, Unidades da Federa√ß√£o e Munic√≠pios";

// governantes devem existir no CSV (voc√™ j√° adicionou)
const GOVCOL_BR  = "Presidente_BR";
const GOVCOL_RS  = "Governador_RS";
const GOVCOL_POA = "Prefeito_POA";

// suas listas de vari√°veis
const POP_COLS = [
  "Popula√ß√£o em idade de trabalhar (1 000 pessoas)",
  "Popula√ß√£o na for√ßa de trabalho (1 000 pessoas)",
  "Popula√ß√£o ocupada (1 000 pessoas)",
  "Popula√ß√£o ocupada em trabalhos formais (1) (1 000 pessoas)",
  "Popula√ß√£o desocupada (1 000 pessoas)",
  "Popula√ß√£o na for√ßa de trabalho potencial (1 000 pessoas)",
  "Popula√ß√£o subutilizada (1 000 pessoas)"
];
const RATE_COLS = [
  "Taxa de participa√ß√£o (%)",
  "N√≠vel de ocupa√ß√£o (%)",
  "Taxa de formaliza√ß√£o (%)",
  "Taxa de desocupa√ß√£o (%)",
  "Taxa composta de subutiliza√ß√£o (%)"
];

// arredondamento exibido
const DEC_TAXAS_VALORES = 1;
const DEC_TAXAS_CV      = 2;

/* Paleta fixa (as barras usam sempre essas cores em ordem) */
const GOV_COLORS = [
  "#d62728", "#1f77b4", "#2ca02c", "#ff7f0e", "#9467bd",
  "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"
];

/* =========================
   ESTADO
========================= */
let DATA_VALORES = [];
let DATA_CV = [];
let activeTab = "valores";   // "valores" | "cv"
let governoAtivo = null;
let lastGovTable = [];

/* =========================
   HELPERS
========================= */
function normText(x){
  if (x === null || x === undefined) return "";
  return String(x).replace(/\s+/g," ").trim();
}
function parseNumber(v){
  if (typeof v === "number" && Number.isFinite(v)) return v;
  if (v === null || v === undefined) return NaN;
  let s = String(v).trim();
  if (!s) return NaN;
  // aceita "62,8" e "62.8"
  if (s.includes(",")) s = s.replace(/\./g,"").replace(",",".");
  s = s.replace(/\s/g,"");
  const num = Number(s);
  return Number.isFinite(num) ? num : NaN;
}
function unique(arr){
  return [...new Set(arr)];
}
function uniqueSorted(arr){
  return unique(arr).sort((a,b)=>{
    if (typeof a === "number" && typeof b === "number") return a-b;
    return String(a).localeCompare(String(b),"pt-BR");
  });
}
function formatBR(num, decimals){
  if (!Number.isFinite(num)) return "‚Äì";
  return num.toLocaleString("pt-BR", { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}
function downloadText(filename, content, mime="text/plain;charset=utf-8"){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function toCSV(rows){
  if (!rows || !rows.length) return "";
  const cols = Object.keys(rows[0]);
  const esc = (v) => {
    if (v === null || v === undefined) return "";
    const s = String(v);
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const head = cols.map(esc).join(",");
  const lines = rows.map(r => cols.map(c => esc(r[c])).join(","));
  return [head, ...lines].join("\n");
}
function hexToRgba(hex, alpha){
  const h = hex.replace("#","");
  const r = parseInt(h.slice(0,2),16);
  const g = parseInt(h.slice(2,4),16);
  const b = parseInt(h.slice(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function linearTrend(y){
  const n = y.length;
  if (n < 2) return y.map(()=>NaN);
  const x = y.map((_,i)=>i);
  const meanX = x.reduce((a,b)=>a+b,0)/n;
  const meanY = y.reduce((a,b)=>a+b,0)/n;
  let num=0, den=0;
  for(let i=0;i<n;i++){
    num += (x[i]-meanX)*(y[i]-meanY);
    den += (x[i]-meanX)*(x[i]-meanX);
  }
  const a = den===0 ? 0 : num/den;
  const b = meanY - a*meanX;
  return x.map(xi=>a*xi+b);
}
function isRateVar(varName){
  return RATE_COLS.includes(varName);
}
function decimalsForCurrent(varName){
  if (activeTab === "valores"){
    return isRateVar(varName) ? DEC_TAXAS_VALORES : 0;
  }
  return isRateVar(varName) ? DEC_TAXAS_CV : 2;
}

/* =========================
   GOVERNOS (coluna conforme localidade)
========================= */
function govColForLocalidade(localidade){
  if (localidade === "Rio Grande do Sul") return GOVCOL_RS;
  if (localidade === "Porto Alegre") return GOVCOL_POA;
  return GOVCOL_BR; // Brasil e Sul
}
function tipoGovernoForLocalidade(localidade){
  if (localidade === "Rio Grande do Sul") return "Governador_RS";
  if (localidade === "Porto Alegre") return "Prefeito_POA";
  return "Presidente_BR";
}

/* =========================
   CSV LOAD
========================= */
function parseCSVFromPath(path){
  return new Promise((resolve,reject)=>{
    Papa.parse(path, {
      download:true,
      header:true,
      dynamicTyping:false,
      skipEmptyLines:true,
      complete: (res)=> resolve(res.data),
      error: (err)=> reject(err)
    });
  });
}
function parseCSVFromFile(file){
  return new Promise((resolve,reject)=>{
    Papa.parse(file, {
      header:true,
      dynamicTyping:false,
      skipEmptyLines:true,
      complete: (res)=> resolve(res.data),
      error: (err)=> reject(err)
    });
  });
}
function coerceRows(rawRows){
  return rawRows.map(r=>{
    const obj = {};
    Object.keys(r).forEach(k=>{
      obj[normText(k)] = r[k];
    });
    obj[COL_ANO] = parseNumber(obj[COL_ANO]);
    obj[COL_LOC] = normText(obj[COL_LOC]);
    // normaliza governantes se existirem
    obj[GOVCOL_BR]  = normText(obj[GOVCOL_BR]);
    obj[GOVCOL_RS]  = normText(obj[GOVCOL_RS]);
    obj[GOVCOL_POA] = normText(obj[GOVCOL_POA]);
    return obj;
  }).filter(r => Number.isFinite(r[COL_ANO]) && r[COL_LOC]);
}

async function loadAllData(){
  const status = document.getElementById("statusText");
  status.textContent = "Carregando dados (arquivos padr√£o)‚Ä¶";

  try{
    const [rawV, rawC] = await Promise.all([
      parseCSVFromPath(PATH_VALORES_DEFAULT),
      parseCSVFromPath(PATH_CV_DEFAULT)
    ]);
    DATA_VALORES = coerceRows(rawV);
    DATA_CV      = coerceRows(rawC);
    status.textContent = "Dados carregados (modo GitHub).";
  }catch(e){
    status.textContent = "N√£o consegui carregar /data/*.csv. Use upload local (nos campos de arquivo).";
    DATA_VALORES = [];
    DATA_CV = [];
  }

  initUI();
}

/* =========================
   UI INIT
========================= */
function initUI(){
  const selLoc = document.getElementById("selLocalidade");
  const selVar = document.getElementById("selVariavel");
  const selMin = document.getElementById("selAnoMin");
  const selMax = document.getElementById("selAnoMax");

  const base = (DATA_VALORES.length ? DATA_VALORES : (DATA_CV.length ? DATA_CV : []));

  const locs = base.length
    ? uniqueSorted(base.map(r=>r[COL_LOC]))
    : ["Brasil","Sul","Rio Grande do Sul","Porto Alegre"];

  selLoc.innerHTML = "";
  locs.forEach(l=>{
    const opt = document.createElement("option");
    opt.value = l;
    opt.textContent = l;
    selLoc.appendChild(opt);
  });

  // Vari√°veis
  selVar.innerHTML = "";
  const addGroup = (label, cols)=>{
    const og = document.createElement("optgroup");
    og.label = label;
    cols.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      og.appendChild(opt);
    });
    selVar.appendChild(og);
  };
  addGroup("Popula√ß√µes (1 000 pessoas)", POP_COLS);
  addGroup("Taxas (%)", RATE_COLS);

  const anos = base.length
    ? uniqueSorted(base.map(r=>r[COL_ANO]).filter(Number.isFinite))
    : Array.from({length:13}, (_,i)=>2012+i);

  selMin.innerHTML = "";
  selMax.innerHTML = "";
  anos.forEach(a=>{
    const o1=document.createElement("option");
    o1.value=a; o1.textContent=a;
    const o2=document.createElement("option");
    o2.value=a; o2.textContent=a;
    selMin.appendChild(o1);
    selMax.appendChild(o2);
  });

  // defaults
  selLoc.value = locs.includes("Rio Grande do Sul") ? "Rio Grande do Sul" : locs[0];
  selVar.value = RATE_COLS[0];
  selMin.value = 2012;
  selMax.value = 2024;

  // tabs
  document.getElementById("tabValores").addEventListener("click", ()=>{
    activeTab = "valores";
    governoAtivo = null;
    document.getElementById("tabValores").classList.add("ativo");
    document.getElementById("tabCV").classList.remove("ativo");
    updateAll();
  });
  document.getElementById("tabCV").addEventListener("click", ()=>{
    activeTab = "cv";
    governoAtivo = null;
    document.getElementById("tabCV").classList.add("ativo");
    document.getElementById("tabValores").classList.remove("ativo");
    updateAll();
  });

  // bot√µes
  document.getElementById("btnAplicar").addEventListener("click", ()=>{ governoAtivo=null; updateAll(); });
  document.getElementById("btnReset").addEventListener("click", ()=>{
    governoAtivo=null;
    selLoc.value = "Rio Grande do Sul";
    selVar.value = RATE_COLS[0];
    selMin.value = 2012;
    selMax.value = 2024;
    updateAll();
  });

  document.getElementById("reset-governo").addEventListener("click", ()=>{
    governoAtivo = null;
    updateAll();
  });

  // uploads
  document.getElementById("fileValores").addEventListener("change", async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    const raw = await parseCSVFromFile(f);
    DATA_VALORES = coerceRows(raw);
    document.getElementById("statusText").textContent = "Valores carregados por upload.";
    updateAll();
  });

  document.getElementById("fileCV").addEventListener("change", async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    const raw = await parseCSVFromFile(f);
    DATA_CV = coerceRows(raw);
    document.getElementById("statusText").textContent = "CV carregado por upload.";
    updateAll();
  });

  // downloads
  document.getElementById("btnDownRecorte").addEventListener("click", ()=>{
    const rec = getRecorteSlim();
    downloadText(`recorte_${activeTab}_${Date.now()}.csv`, toCSV(rec), "text/csv;charset=utf-8");
  });

  document.getElementById("btnDownTabela").addEventListener("click", ()=>{
    downloadText(`tabela_governos_${activeTab}_${Date.now()}.csv`, toCSV(lastGovTable || []), "text/csv;charset=utf-8");
  });

  document.getElementById("btnDownPNG").addEventListener("click", async ()=>{
    try{
      const gd = document.getElementById("grafico");
      const url = await Plotly.toImage(gd, {format:"png", height:700, width:1200});
      const a = document.createElement("a");
      a.href = url;
      a.download = `grafico_${activeTab}_${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }catch(e){
      alert("N√£o consegui gerar PNG. Tenta novamente ap√≥s o gr√°fico carregar.");
    }
  });

  document.getElementById("btnDownPDF").addEventListener("click", ()=>{
    const el = document.getElementById("dashboardRoot");
    const opt = {
      margin:       0.35,
      filename:     `painel_${activeTab}_${Date.now()}.pdf`,
      image:        { type: 'jpeg', quality: 0.95 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(el).save();
  });

  updateAll();
}

/* =========================
   FILTRO BASE
========================= */
function getDataset(){
  return (activeTab === "valores") ? DATA_VALORES : DATA_CV;
}

function getFilteredRows(){
  const ds = getDataset();
  const selLoc = document.getElementById("selLocalidade").value;
  let minY = parseNumber(document.getElementById("selAnoMin").value);
  let maxY = parseNumber(document.getElementById("selAnoMax").value);
  if (!Number.isFinite(minY)) minY = 2012;
  if (!Number.isFinite(maxY)) maxY = 2024;
  if (minY > maxY){ const t=minY; minY=maxY; maxY=t; }

  return ds
    .filter(r => r[COL_LOC] === selLoc)
    .filter(r => Number.isFinite(r[COL_ANO]) && r[COL_ANO] >= minY && r[COL_ANO] <= maxY)
    .sort((a,b)=>a[COL_ANO]-b[COL_ANO]);
}

/* recorte para download */
function getRecorteSlim(){
  const rows = getFilteredRows();
  const selVar = document.getElementById("selVariavel").value;
  const selLoc = document.getElementById("selLocalidade").value;
  const govCol = govColForLocalidade(selLoc);
  const tipoGov = tipoGovernoForLocalidade(selLoc);
  const dec = decimalsForCurrent(selVar);

  const out = [];
  rows.forEach(r=>{
    const ano = Number(r[COL_ANO]);
    const gov = normText(r[govCol]) || "";
    if (governoAtivo && gov !== governoAtivo) return;

    const v = parseNumber(r[selVar]);
    out.push({
      Ano: ano,
      Localidade: selLoc,
      Tipo_Governo: tipoGov,
      Governo: gov,
      Variavel: selVar,
      Valor_num: Number.isFinite(v) ? v : "",
      Valor_fmt: Number.isFinite(v) ? formatBR(v, dec) : "‚Äì"
    });
  });
  return out;
}

/* =========================
   SEGMENTOS DE GOVERNO (para barras + painel)
   - usa a coluna do CSV (Presidente_BR / Governador_RS / Prefeito_POA)
========================= */
function buildGovSegmentsFromRows(rows, selLoc){
  const govCol = govColForLocalidade(selLoc);

  // anos como STRING no eixo X (garante shapes funcionarem)
  const years = rows.map(r => String(Math.trunc(r[COL_ANO])));

  const govs = rows.map(r => normText(r[govCol]) || "");

  // se o CSV vier sem governante, devolve vazio
  const anyGov = govs.some(g=>g);
  if (!anyGov){
    return { segments: [], yearLabels: years };
  }

  // cria segmentos por mudan√ßas de governo
  const segments = [];
  let startIdx = 0;
  for(let i=1;i<govs.length;i++){
    if (govs[i] !== govs[i-1]){
      segments.push({
        gov: govs[i-1],
        x0: years[startIdx],
        x1: years[i-1]
      });
      startIdx = i;
    }
  }
  // √∫ltimo
  segments.push({
    gov: govs[govs.length-1],
    x0: years[startIdx],
    x1: years[years.length-1]
  });

  // cores (mapeia por ordem de aparecimento)
  const govList = unique(segments.map(s=>s.gov).filter(Boolean));
  const colorMap = {};
  govList.forEach((g,i)=>{ colorMap[g] = GOV_COLORS[i % GOV_COLORS.length]; });

  segments.forEach(s=>{ s.cor = colorMap[s.gov] || "#888"; });

  return { segments, yearLabels: years, colorMap };
}

/* =========================
   RENDER
========================= */
function updateAll(){
  const status = document.getElementById("statusText");
  const ds = getDataset();

  if (!ds.length){
    status.textContent = `Sem dados carregados para a aba ${activeTab.toUpperCase()} (use /data/*.csv ou upload).`;
  } else {
    status.textContent = `OK ‚Ä¢ Aba: ${activeTab.toUpperCase()} ‚Ä¢ Clique em um governo para filtrar.`;
  }

  const rows = getFilteredRows();
  renderChartAndGovPanel(rows);
  renderGovTable(rows);
}

function renderChartAndGovPanel(rows){
  const selVar = document.getElementById("selVariavel").value;
  const selLoc = document.getElementById("selLocalidade").value;
  const dec = decimalsForCurrent(selVar);

  // segmentos de governo baseados no CSV
  const { segments, yearLabels } = buildGovSegmentsFromRows(rows, selLoc);

  // se usu√°rio clicou num governo, filtra as linhas
  let base = rows.slice();
  const govCol = govColForLocalidade(selLoc);
  if (governoAtivo){
    base = base.filter(r => normText(r[govCol]) === governoAtivo);
  }

  // eixo X: anos como string (categoria)
  const xLabels = base.map(r => String(Math.trunc(r[COL_ANO])));

  // s√©rie y
  const y = base.map(r => parseNumber(r[selVar]));
  const xy = xLabels.map((x,i)=>({x, y:y[i]})).filter(p=>Number.isFinite(p.y));

  const xs = xy.map(p=>p.x);
  const ys = xy.map(p=>p.y);

  // m√©dia / tend√™ncia
  const mean = ys.length ? ys.reduce((a,b)=>a+b,0)/ys.length : NaN;
  const trend = linearTrend(ys);

  // BARRAS NO FUNDO (shapes) ‚Äî usando x0/x1 como LABELS do eixo X (strings)
  const shapes = [];
  const segsVis = governoAtivo ? segments.filter(s=>s.gov===governoAtivo) : segments;

  segsVis.forEach(s=>{
    if(!s.gov) return;
    shapes.push({
      type:"rect",
      xref:"x",
      yref:"paper",
      x0:s.x0,
      x1:s.x1,
      y0:0,
      y1:1,
      fillcolor: hexToRgba(s.cor, 0.18),  // mais vis√≠vel
      line:{width:0},
      layer:"below"
    });
  });

  const traces = [];

  traces.push({
    x: xs,
    y: ys,
    mode: "lines+markers",
    name: "S√©rie",
    line: { color: "#1f77b4" },
    hovertemplate: `Ano=%{x}<br>Valor=%{y}<extra></extra>`
  });

  if (ys.length){
    traces.push({
      x: xs,
      y: xs.map(()=>mean),
      mode: "lines",
      name: "M√©dia",
      line: { color: "#1f77b4", dash: "dot" },
      hovertemplate: `M√©dia=%{y}<extra></extra>`
    });

    traces.push({
      x: xs,
      y: trend,
      mode: "lines",
      name: "Tend√™ncia",
      line: { color: "#d62728", dash: "dash" },
      hovertemplate: `Tend√™ncia=%{y}<extra></extra>`
    });
  }

  // t√≠tulo
  const titulo = `${selLoc}: ${selVar}`.replace(": ", ":<br>");

  Plotly.newPlot("grafico", traces, {
    title: { text: titulo, x: 0.5, xanchor: "center" },
    xaxis: {
      title: "Ano",
      type: "category",
      tickangle: -45
    },
    yaxis: { title: activeTab === "cv" ? "CV" : "Valor" },
    shapes: shapes,
    height: 560,
    margin: { l: 70, r: 20, t: 90, b: 110 },
    legend: { orientation: "v" }
  }, { displaylogo:false, responsive:true }).then(()=>{
    // ap√≥s o plot, atualiza hover com formata√ß√£o (pt-BR)
    try{
      Plotly.restyle("grafico", {
        hovertemplate: [`Ano=%{x}<br>Valor=%{y:${dec===0 ? ",.0f" : ",."+dec+"f"}}<extra></extra>`]
      }, [0]);
      if (ys.length){
        Plotly.restyle("grafico", {
          hovertemplate: [`M√©dia=%{y:${dec===0 ? ",.0f" : ",."+dec+"f"}}<extra></extra>`]
        }, [1]);
        Plotly.restyle("grafico", {
          hovertemplate: [`Tend√™ncia=%{y:${dec===0 ? ",.0f" : ",."+dec+"f"}}<extra></extra>`]
        }, [2]);
      }
    }catch(e){}
  });

  // painel lateral: SEMPRE mostrar
  renderGovPanel(segments);
}

function renderGovPanel(segments){
  const painel = document.getElementById("painel-governos");
  const btnReset = document.getElementById("reset-governo");
  painel.innerHTML = "";

  // lista √∫nica preservando ordem
  const govs = [];
  segments.forEach(s=>{
    if (s.gov && !govs.includes(s.gov)){
      govs.push(s.gov);
    }
  });

  // se ainda n√£o houver (CSV vazio), mostrar mensagem
  if (!govs.length){
    painel.innerHTML = `<div style="font-size:.8rem;color:#666;line-height:1.3;">
      Nenhum governante encontrado no CSV para este recorte.<br/>
      Verifique as colunas: Presidente_BR / Governador_RS / Prefeito_POA.
    </div>`;
    btnReset.style.display = "none";
    return;
  }

  // mapa cor por governo (do primeiro segmento de cada gov)
  const colorByGov = {};
  segments.forEach(s=>{
    if (s.gov && !colorByGov[s.gov]) colorByGov[s.gov] = s.cor || "#888";
  });

  govs.forEach(g=>{
    const segs = segments.filter(s=>s.gov===g);
    const ini = segs[0]?.x0 ?? "";
    const fim = segs[segs.length-1]?.x1 ?? "";

    const div = document.createElement("div");
    div.className = "gov-item" + (governoAtivo === g ? " ativo" : "");
    div.style.backgroundColor = colorByGov[g] || "#888";
    div.innerHTML = `<div>${g}</div><div class="gov-sub">${ini} ‚Üí ${fim}</div>`;

    div.addEventListener("click", ()=>{
      governoAtivo = (governoAtivo === g) ? null : g;
      updateAll();
    });

    painel.appendChild(div);
  });

  btnReset.style.display = governoAtivo ? "inline-block" : "none";
}

/* =========================
   TABELA POR GOVERNO (com base no CSV)
========================= */
function renderGovTable(rows){
  const tbody = document.querySelector("#tabela-estat tbody");
  tbody.innerHTML = "";

  const selVar = document.getElementById("selVariavel").value;
  const selLoc = document.getElementById("selLocalidade").value;
  const govCol = govColForLocalidade(selLoc);
  const dec = decimalsForCurrent(selVar);

  // prepara anos em ordem
  const base = rows.slice().sort((a,b)=>a[COL_ANO]-b[COL_ANO]);

  // grupos por governo (ordem de aparecimento)
  const govOrder = [];
  base.forEach(r=>{
    const g = normText(r[govCol]) || "";
    if (g && !govOrder.includes(g)) govOrder.push(g);
  });

  // se filtrado por governoAtivo
  const govList = governoAtivo ? govOrder.filter(g=>g===governoAtivo) : govOrder;

  const stats = [];

  govList.forEach(g=>{
    const subset = base.filter(r => normText(r[govCol]) === g);
    if (!subset.length) return;

    const anos = subset.map(r=>Math.trunc(r[COL_ANO])).filter(Number.isFinite);
    const ini = Math.min(...anos);
    const fim = Math.max(...anos);

    const values = subset.map(r=>parseNumber(r[selVar])).filter(Number.isFinite);
    if (!values.length) return;

    const mean = values.reduce((a,b)=>a+b,0)/values.length;
    const minv = Math.min(...values);
    const maxv = Math.max(...values);

    const varIntra = (minv !== 0) ? ((maxv - minv) / Math.abs(minv)) * 100 : NaN;

    stats.push({
      Governo: g,
      Inicio: ini,
      Fim: fim,
      N_anos: values.length,
      Media_num: mean,
      Minimo_num: minv,
      Maximo_num: maxv,
      Variacao_interna_pct_num: Number.isFinite(varIntra) ? varIntra : NaN
    });
  });

  // varia√ß√£o vs anterior (m√©dia)
  for (let i=0;i<stats.length;i++){
    if (i===0){
      stats[i].Delta_media_vs_anterior_pct_num = NaN;
    } else {
      const prev = stats[i-1].Media_num;
      const cur  = stats[i].Media_num;
      stats[i].Delta_media_vs_anterior_pct_num = (prev !== 0) ? ((cur - prev) / Math.abs(prev)) * 100 : NaN;
    }
  }

  lastGovTable = stats.map(s=>({
    Governo: s.Governo,
    Inicio: s.Inicio,
    Fim: s.Fim,
    N_anos: s.N_anos,
    Media: formatBR(s.Media_num, dec),
    Minimo: formatBR(s.Minimo_num, dec),
    Maximo: formatBR(s.Maximo_num, dec),
    Variacao_interna_pct: Number.isFinite(s.Variacao_interna_pct_num) ? formatBR(s.Variacao_interna_pct_num, 1) + "%" : "‚Äì",
    Delta_media_vs_anterior_pct: Number.isFinite(s.Delta_media_vs_anterior_pct_num) ? formatBR(s.Delta_media_vs_anterior_pct_num, 1) + "%" : "‚Äì"
  }));

  lastGovTable.forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="font-weight:900;">${row.Governo}</td>
      <td>${row.Inicio}</td>
      <td>${row.Fim}</td>
      <td>${row.N_anos}</td>
      <td>${row.Media}</td>
      <td>${row.Minimo}</td>
      <td>${row.Maximo}</td>
      <td>${row.Variacao_interna_pct}</td>
      <td>${row.Delta_media_vs_anterior_pct}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================
   START
========================= */
(function setFooterDate(){
  const hoje = new Date();
  document.getElementById("data-atualizacao").textContent =
    "Atualizado em: " + hoje.toLocaleDateString("pt-BR");
})();
loadAllData();
</script>

</body>
</html>
