<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel â€¢ 2012â€“2024 (Valores e CV) â€” Indicadores (IBGE)</title>

  <!-- Plotly + PapaParse + html2pdf -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --azul-escuro:#002b5c;
      --cinza-fundo:#f5f6fa;
      --borda:#dcdfe6;
      --texto:#222;
      --muted:#666;
      --card:#fff;
    }
    body{
      margin:0;
      background:var(--cinza-fundo);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--texto);
    }
    header{
      background:var(--azul-escuro);
      color:#fff;
      padding:16px 24px;
      text-align:center;
      font-size:1.05rem;
      font-weight:800;
      letter-spacing:.02em;
    }
    main{
      max-width:1400px;
      margin:24px auto 64px auto;
      padding:0 16px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .card{
      background:var(--card);
      border-radius:12px;
      border:1px solid var(--borda);
      box-shadow:0 8px 24px rgba(0,0,0,.04);
      padding:16px 18px 18px 18px;
    }
    .titulo-bloco{
      font-size:1rem;
      font-weight:800;
      color:var(--azul-escuro);
      margin:0 0 8px 0;
      line-height:1.3;
      text-align:center;
    }
    .sub-bloco{
      font-size:.82rem;
      font-weight:400;
      color:#555;
      text-align:center;
      margin-top:-2px;
      margin-bottom:14px;
      line-height:1.4;
    }

    .tabs{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .tabbtn{
      border:1px solid var(--borda);
      background:#fff;
      color:#222;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:.85rem;
      font-weight:750;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .tabbtn.ativo{
      background:var(--azul-escuro);
      border-color:var(--azul-escuro);
      color:#fff;
    }

    #filtros{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      justify-content:center;
      align-items:flex-end;
    }
    .filtro-group{
      display:flex;
      flex-direction:column;
      font-size:.8rem;
      color:#444;
      min-width:220px;
    }
    .filtro-group label{
      font-weight:750;
      margin-bottom:4px;
    }
    select, input[type="file"]{
      background:#fff;
      border:1px solid var(--borda);
      border-radius:10px;
      padding:9px 10px;
      font-size:.85rem;
      color:#222;
      outline:none;
    }

    .linha-acoes{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      align-items:center;
      margin-top:10px;
    }
    .btn{
      border:1px solid var(--borda);
      background:#fff;
      padding:9px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:.85rem;
      font-weight:750;
      user-select:none;
    }
    .btn:hover{ background:#f0f3f9; }
    .btn.primary{
      background:var(--azul-escuro);
      border-color:var(--azul-escuro);
      color:#fff;
    }
    .btn.primary:hover{ filter:brightness(.95); }
    .status{
      font-size:.78rem;
      color:var(--muted);
      text-align:center;
      margin-top:8px;
    }

    #viz-wrapper{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:stretch;
    }
    #grafico-wrapper{
      flex:1;
      min-width:320px;
    }
    #grafico{
      width:100%;
      min-height:520px;
    }

    #painel-governos-wrapper{
      width:270px;
      min-width:270px;
      border-left:1px solid var(--borda);
      padding-left:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    #painel-governos-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    #painel-governos-header span{
      font-size:.82rem;
      font-weight:900;
      color:#333;
    }
    #reset-governo{
      font-size:.72rem;
      background:#fff;
      border:1px solid var(--borda);
      border-radius:8px;
      padding:6px 8px;
      cursor:pointer;
      line-height:1.1;
      display:none;
    }
    #reset-governo:hover{ background:#f0f0f0; }

    #painel-governos{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .gov-item{
      border-radius:10px;
      padding:9px 10px;
      font-size:.78rem;
      line-height:1.25;
      color:#fff;
      font-weight:850;
      cursor:pointer;
      border:2px solid transparent;
      user-select:none;
    }
    .gov-sub{
      opacity:.95;
      font-weight:650;
      font-size:.72rem;
      margin-top:2px;
    }
    .gov-item.ativo{
      border-color:#000;
      box-shadow:0 0 0 2px #000 inset;
    }

    #tabela-wrapper{ overflow-x:auto; }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:900px;
      font-size:.82rem;
    }
    thead th{
      background:var(--azul-escuro);
      color:#fff;
      font-weight:900;
      text-align:center;
      padding:9px 7px;
      white-space:nowrap;
    }
    tbody td{
      text-align:center;
      padding:9px 7px;
      border-bottom:1px solid var(--borda);
      background:#fff;
      color:#333;
    }
    tbody tr:hover td{ background:#f9fbff; }

    footer{
      text-align:center;
      font-size:.74rem;
      color:#666;
      padding:26px 14px 30px 14px;
    }
    footer a{ color:#1f77b4; text-decoration:none; }
    footer a:hover{ text-decoration:underline; }

    @media(max-width:980px){
      #viz-wrapper{ flex-direction:column; }
      #painel-governos-wrapper{
        width:100%;
        min-width:auto;
        border-left:none;
        border-top:1px solid var(--borda);
        padding-left:0;
        padding-top:12px;
      }
    }
  </style>
</head>

<body>
<header>ðŸ“Š Painel Interativo â€¢ Indicadores do Mercado de Trabalho (IBGE)</header>

<main id="dashboardRoot">

  <section class="card">
    <h2 class="titulo-bloco">Painel â€¢ 2012â€“2024 (Valores e Coeficiente de VariaÃ§Ã£o)</h2>
    <div class="sub-bloco">Filtros por localidade e variÃ¡vel + leitura por governo (mÃ©dia, tendÃªncia e variaÃ§Ãµes).</div>

    <div class="tabs">
      <button class="tabbtn ativo" id="tabValores">ðŸ“Œ Valores</button>
      <button class="tabbtn" id="tabCV">ðŸ“Ž CV</button>
    </div>

    <div id="filtros">
      <div class="filtro-group">
        <label for="selLocalidade">Localidade</label>
        <select id="selLocalidade"></select>
      </div>

      <div class="filtro-group">
        <label for="selVariavel">VariÃ¡vel</label>
        <select id="selVariavel"></select>
      </div>

      <div class="filtro-group">
        <label for="selAnoMin">Ano (min/max)</label>
        <div style="display:flex; gap:10px;">
          <select id="selAnoMin" style="flex:1;"></select>
          <select id="selAnoMax" style="flex:1;"></select>
        </div>
      </div>

      <div class="filtro-group">
        <label>Carregar dados (opcional)</label>
        <input type="file" id="fileValores" accept=".csv,text/csv" />
        <div style="height:8px;"></div>
        <input type="file" id="fileCV" accept=".csv,text/csv" />
        <div style="font-size:.72rem;color:#666;margin-top:6px;">
          Se estiver no GitHub, pode ignorar (usa /data/*.csv).
        </div>
      </div>
    </div>

    <div class="linha-acoes">
      <button class="btn primary" id="btnAplicar">Aplicar</button>
      <button class="btn" id="btnReset">Reset</button>

      <button class="btn" id="btnDownRecorte">Baixar CSV (recorte)</button>
      <button class="btn" id="btnDownTabela">Baixar CSV (tabela governos)</button>
      <button class="btn" id="btnDownPNG">Baixar PNG (grÃ¡fico)</button>
      <button class="btn" id="btnDownPDF">Exportar PDF</button>
    </div>

    <div class="status" id="statusText">Carregando dadosâ€¦</div>
  </section>

  <section class="card">
    <div id="viz-wrapper">
      <div id="grafico-wrapper">
        <div id="grafico"></div>
      </div>

      <aside id="painel-governos-wrapper">
        <div id="painel-governos-header">
          <span>Governos (clique para filtrar)</span>
          <button id="reset-governo">Mostrar todos</button>
        </div>
        <div id="painel-governos"></div>
      </aside>
    </div>
  </section>

  <section class="card">
    <h2 class="titulo-bloco">ðŸ“ˆ EstatÃ­sticas por governo</h2>
    <div class="sub-bloco">
      MÃ©dia, mÃ­nimo, mÃ¡ximo, variaÃ§Ã£o interna e variaÃ§Ã£o em relaÃ§Ã£o ao governo anterior (no recorte selecionado).
    </div>

    <div id="tabela-wrapper">
      <table id="tabela-estat">
        <thead>
          <tr>
            <th>Governo</th>
            <th>InÃ­cio</th>
            <th>Fim</th>
            <th>N (anos)</th>
            <th>MÃ©dia</th>
            <th>MÃ­nimo</th>
            <th>MÃ¡ximo</th>
            <th>VariaÃ§Ã£o interna (%)</th>
            <th>Î” MÃ©dia vs. anterior (%)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</main>

<footer>
  Fonte: IBGE â€” SÃ­ntese de Indicadores Sociais, 2025. DisponÃ­vel em:
  <a href="https://www.ibge.gov.br/estatisticas/sociais/trabalho/9221-sintese-de-indicadores-sociais.html?=&t=resultados" target="_blank" rel="noopener noreferrer">
    pÃ¡gina do IBGE
  </a>.
  <br/>
  Painel exploratÃ³rio â€¢ CÃ¡lculos e visualizaÃ§Ã£o: Lucas Cunha â€¢ <span id="data-atualizacao"></span>
</footer>

<script>
/* =========================
   CONFIG
========================= */
const PATH_VALORES_DEFAULT = "data/painel_valores.csv";
const PATH_CV_DEFAULT      = "data/painel_cv.csv";

const COL_ANO = "Ano";
const COL_LOC = "Grandes RegiÃµes, Unidades da FederaÃ§Ã£o e MunicÃ­pios";

const GOVCOL_BR  = "Presidente_BR";
const GOVCOL_RS  = "Governador_RS";
const GOVCOL_POA = "Prefeito_POA";

const POP_COLS = [
  "PopulaÃ§Ã£o em idade de trabalhar (1 000 pessoas)",
  "PopulaÃ§Ã£o na forÃ§a de trabalho (1 000 pessoas)",
  "PopulaÃ§Ã£o ocupada (1 000 pessoas)",
  "PopulaÃ§Ã£o ocupada em trabalhos formais (1) (1 000 pessoas)",
  "PopulaÃ§Ã£o desocupada (1 000 pessoas)",
  "PopulaÃ§Ã£o na forÃ§a de trabalho potencial (1 000 pessoas)",
  "PopulaÃ§Ã£o subutilizada (1 000 pessoas)"
];
const RATE_COLS = [
  "Taxa de participaÃ§Ã£o (%)",
  "NÃ­vel de ocupaÃ§Ã£o (%)",
  "Taxa de formalizaÃ§Ã£o (%)",
  "Taxa de desocupaÃ§Ã£o (%)",
  "Taxa composta de subutilizaÃ§Ã£o (%)"
];

const DEC_TAXAS_VALORES = 1;
const DEC_TAXAS_CV      = 2;

const GOV_COLORS = [
  "#d62728", "#1f77b4", "#2ca02c", "#ff7f0e", "#9467bd",
  "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"
];

/* =========================
   ESTADO
========================= */
let DATA_VALORES = [];
let DATA_CV = [];
let activeTab = "valores";
let governoAtivo = null;
let lastGovTable = [];

/* =========================
   HELPERS
========================= */
function normKey(k){
  if (k === null || k === undefined) return "";
  return String(k).replace(/^\uFEFF/,"").replace(/\s+/g," ").trim();
}
function normText(x){
  if (x === null || x === undefined) return "";
  return String(x).replace(/\s+/g," ").trim();
}
function parseNumber(v){
  if (typeof v === "number" && Number.isFinite(v)) return v;
  if (v === null || v === undefined) return NaN;
  let s = String(v).trim();
  if (!s) return NaN;
  if (s.includes(",")) s = s.replace(/\./g,"").replace(",",".");
  s = s.replace(/\s/g,"");
  const num = Number(s);
  return Number.isFinite(num) ? num : NaN;
}
function unique(arr){ return [...new Set(arr)]; }
function uniqueSorted(arr){
  return unique(arr).sort((a,b)=>{
    if (typeof a === "number" && typeof b === "number") return a-b;
    return String(a).localeCompare(String(b),"pt-BR");
  });
}
function formatBR(num, decimals){
  if (!Number.isFinite(num)) return "â€“";
  return num.toLocaleString("pt-BR", { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}
function downloadText(filename, content, mime="text/plain;charset=utf-8"){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function toCSV(rows){
  if (!rows || !rows.length) return "";
  const cols = Object.keys(rows[0]);
  const esc = (v) => {
    if (v === null || v === undefined) return "";
    const s = String(v);
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const head = cols.map(esc).join(",");
  const lines = rows.map(r => cols.map(c => esc(r[c])).join(","));
  return [head, ...lines].join("\n");
}
function hexToRgba(hex, alpha){
  const h = hex.replace("#","");
  const r = parseInt(h.slice(0,2),16);
  const g = parseInt(h.slice(2,4),16);
  const b = parseInt(h.slice(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function isRateVar(v){ return RATE_COLS.includes(v); }
function decimalsForCurrent(varName){
  if (activeTab === "valores"){
    return isRateVar(varName) ? DEC_TAXAS_VALORES : 0;
  }
  return isRateVar(varName) ? DEC_TAXAS_CV : 2;
}
function govColForLocalidade(localidade){
  if (localidade === "Rio Grande do Sul") return GOVCOL_RS;
  if (localidade === "Porto Alegre") return GOVCOL_POA;
  return GOVCOL_BR; // Brasil e Sul
}
function tipoGovernoForLocalidade(localidade){
  if (localidade === "Rio Grande do Sul") return "Governador_RS";
  if (localidade === "Porto Alegre") return "Prefeito_POA";
  return "Presidente_BR";
}

/* RegressÃ£o linear y = a*x + b (x=ano) */
function linearTrendXY(xs, ys){
  const pts = xs.map((x,i)=>({x, y:ys[i]})).filter(p=>Number.isFinite(p.x) && Number.isFinite(p.y));
  if (pts.length < 2) return xs.map(()=>null);

  const n = pts.length;
  const meanX = pts.reduce((s,p)=>s+p.x,0)/n;
  const meanY = pts.reduce((s,p)=>s+p.y,0)/n;

  let num=0, den=0;
  for(const p of pts){
    num += (p.x-meanX)*(p.y-meanY);
    den += (p.x-meanX)*(p.x-meanX);
  }
  const a = den===0 ? 0 : num/den;
  const b = meanY - a*meanX;

  return xs.map(x => Number.isFinite(x) ? (a*x + b) : null);
}

/* =========================
   CSV LOAD
========================= */
function parseCSVFromPath(path){
  return new Promise((resolve,reject)=>{
    Papa.parse(path, {
      download:true,
      header:true,
      dynamicTyping:false,
      skipEmptyLines:true,
      complete: (res)=> resolve(res.data),
      error: (err)=> reject(err)
    });
  });
}
function parseCSVFromFile(file){
  return new Promise((resolve,reject)=>{
    Papa.parse(file, {
      header:true,
      dynamicTyping:false,
      skipEmptyLines:true,
      complete: (res)=> resolve(res.data),
      error: (err)=> reject(err)
    });
  });
}

/* robusto: aceita Ano ou "no" */
function coerceRows(rawRows){
  return rawRows.map(r=>{
    const obj = {};
    Object.keys(r).forEach(k=>{
      obj[normKey(k)] = r[k];
    });

    const anoRaw = (obj[COL_ANO] ?? obj["no"] ?? obj["ANO"] ?? obj["Ano"] ?? obj["Ano "]);
    obj[COL_ANO] = parseNumber(anoRaw);

    const locRaw = (obj[COL_LOC] ?? obj["Grandes Regioes, Unidades da Federacao e Municipios"] ?? obj["Grandes RegiÃµes, Unidades da FederaÃ§Ã£o e MunicÃ­pios"]);
    obj[COL_LOC] = normText(locRaw);

    obj[GOVCOL_BR]  = normText(obj[GOVCOL_BR]);
    obj[GOVCOL_RS]  = normText(obj[GOVCOL_RS]);
    obj[GOVCOL_POA] = normText(obj[GOVCOL_POA]);

    return obj;
  }).filter(r => Number.isFinite(r[COL_ANO]) && r[COL_LOC]);
}

async function loadAllData(){
  const status = document.getElementById("statusText");
  status.textContent = "Carregando dados (arquivos padrÃ£o)â€¦";
  try{
    const [rawV, rawC] = await Promise.all([
      parseCSVFromPath(PATH_VALORES_DEFAULT),
      parseCSVFromPath(PATH_CV_DEFAULT)
    ]);
    DATA_VALORES = coerceRows(rawV);
    DATA_CV      = coerceRows(rawC);
    status.textContent = "Dados carregados (modo GitHub).";
  }catch(e){
    status.textContent = "NÃ£o consegui carregar /data/*.csv. Use upload local (nos campos de arquivo).";
    DATA_VALORES = [];
    DATA_CV = [];
  }
  initUI();
}

/* =========================
   UI INIT
========================= */
function getDataset(){
  return (activeTab === "valores") ? DATA_VALORES : DATA_CV;
}

function initUI(){
  const selLoc = document.getElementById("selLocalidade");
  const selVar = document.getElementById("selVariavel");
  const selMin = document.getElementById("selAnoMin");
  const selMax = document.getElementById("selAnoMax");

  const base = (DATA_VALORES.length ? DATA_VALORES : (DATA_CV.length ? DATA_CV : []));

  const locs = base.length
    ? uniqueSorted(base.map(r=>r[COL_LOC]))
    : ["Brasil","Sul","Rio Grande do Sul","Porto Alegre"];

  selLoc.innerHTML = "";
  locs.forEach(l=>{
    const opt = document.createElement("option");
    opt.value = l;
    opt.textContent = l;
    selLoc.appendChild(opt);
  });

  selVar.innerHTML = "";
  const addGroup = (label, cols)=>{
    const og = document.createElement("optgroup");
    og.label = label;
    cols.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      og.appendChild(opt);
    });
    selVar.appendChild(og);
  };
  addGroup("PopulaÃ§Ãµes (1 000 pessoas)", POP_COLS);
  addGroup("Taxas (%)", RATE_COLS);

  const anos = base.length
    ? uniqueSorted(base.map(r=>Math.trunc(r[COL_ANO])).filter(Number.isFinite))
    : Array.from({length:13}, (_,i)=>2012+i);

  selMin.innerHTML = "";
  selMax.innerHTML = "";
  anos.forEach(a=>{
    const o1=document.createElement("option");
    o1.value=a; o1.textContent=a;
    const o2=document.createElement("option");
    o2.value=a; o2.textContent=a;
    selMin.appendChild(o1);
    selMax.appendChild(o2);
  });

  selLoc.value = locs.includes("Brasil") ? "Brasil" : locs[0];
  selVar.value = RATE_COLS[0];
  selMin.value = anos[0] ?? 2012;
  selMax.value = anos[anos.length-1] ?? 2024;

  document.getElementById("tabValores").addEventListener("click", ()=>{
    activeTab = "valores";
    governoAtivo = null;
    document.getElementById("tabValores").classList.add("ativo");
    document.getElementById("tabCV").classList.remove("ativo");
    updateAll();
  });
  document.getElementById("tabCV").addEventListener("click", ()=>{
    activeTab = "cv";
    governoAtivo = null;
    document.getElementById("tabCV").classList.add("ativo");
    document.getElementById("tabValores").classList.remove("ativo");
    updateAll();
  });

  document.getElementById("btnAplicar").addEventListener("click", ()=>{ governoAtivo=null; updateAll(); });
  document.getElementById("btnReset").addEventListener("click", ()=>{
    governoAtivo=null;
    selLoc.value = "Brasil";
    selVar.value = RATE_COLS[0];
    selMin.value = anos[0] ?? 2012;
    selMax.value = anos[anos.length-1] ?? 2024;
    updateAll();
  });

  document.getElementById("reset-governo").addEventListener("click", ()=>{
    governoAtivo = null;
    updateAll();
  });

  document.getElementById("fileValores").addEventListener("change", async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    const raw = await parseCSVFromFile(f);
    DATA_VALORES = coerceRows(raw);
    document.getElementById("statusText").textContent = "Valores carregados por upload.";
    updateAll();
  });

  document.getElementById("fileCV").addEventListener("change", async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    const raw = await parseCSVFromFile(f);
    DATA_CV = coerceRows(raw);
    document.getElementById("statusText").textContent = "CV carregado por upload.";
    updateAll();
  });

  document.getElementById("btnDownRecorte").addEventListener("click", ()=>{
    const rec = getRecorteSlim();
    downloadText(`recorte_${activeTab}_${Date.now()}.csv`, toCSV(rec), "text/csv;charset=utf-8");
  });

  document.getElementById("btnDownTabela").addEventListener("click", ()=>{
    downloadText(`tabela_governos_${activeTab}_${Date.now()}.csv`, toCSV(lastGovTable || []), "text/csv;charset=utf-8");
  });

  document.getElementById("btnDownPNG").addEventListener("click", async ()=>{
    try{
      const gd = document.getElementById("grafico");
      const url = await Plotly.toImage(gd, {format:"png", height:700, width:1200});
      const a = document.createElement("a");
      a.href = url;
      a.download = `grafico_${activeTab}_${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }catch(e){
      alert("NÃ£o consegui gerar PNG. Tenta novamente apÃ³s o grÃ¡fico carregar.");
    }
  });

  document.getElementById("btnDownPDF").addEventListener("click", ()=>{
    const el = document.getElementById("dashboardRoot");
    const opt = {
      margin:       0.35,
      filename:     `painel_${activeTab}_${Date.now()}.pdf`,
      image:        { type: 'jpeg', quality: 0.95 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(el).save();
  });

  updateAll();
}

/* =========================
   FILTRO + SÃ‰RIE ANUAL COMPLETA
========================= */
function getFilteredRows(){
  const ds = getDataset();
  const selLoc = document.getElementById("selLocalidade").value;
  let minY = parseNumber(document.getElementById("selAnoMin").value);
  let maxY = parseNumber(document.getElementById("selAnoMax").value);
  if (!Number.isFinite(minY)) minY = 2012;
  if (!Number.isFinite(maxY)) maxY = 2024;
  if (minY > maxY){ const t=minY; minY=maxY; maxY=t; }

  return ds
    .filter(r => r[COL_LOC] === selLoc)
    .filter(r => Number.isFinite(r[COL_ANO]) && r[COL_ANO] >= minY && r[COL_ANO] <= maxY)
    .sort((a,b)=>a[COL_ANO]-b[COL_ANO]);
}

/* monta (anos completos) + y por ano (mÃ©dia se houver duplicatas) + gov por ano */
function buildAnnualSeries(rows, selVar, selLoc){
  const minY = Math.trunc(parseNumber(document.getElementById("selAnoMin").value));
  const maxY = Math.trunc(parseNumber(document.getElementById("selAnoMax").value));
  const govCol = govColForLocalidade(selLoc);

  const map = new Map(); // year -> {vals:[], gov:""}
  for(const r of rows){
    const y = Math.trunc(r[COL_ANO]);
    if (!Number.isFinite(y)) continue;
    const v = parseNumber(r[selVar]);
    const g = normText(r[govCol]) || "";
    if (!map.has(y)) map.set(y, {vals:[], gov:g});
    const obj = map.get(y);
    if (Number.isFinite(v)) obj.vals.push(v);
    if (!obj.gov && g) obj.gov = g;
  }

  const years = [];
  const values = [];
  const govs = [];

  for(let y=minY; y<=maxY; y++){
    years.push(y);
    if (map.has(y) && map.get(y).vals.length){
      const arr = map.get(y).vals;
      const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
      values.push(mean);
    } else {
      values.push(null);
    }
    govs.push(map.has(y) ? (map.get(y).gov || "") : "");
  }

  return { years, values, govs };
}

/* segmentos consecutivos de governo */
function buildGovSegments(years, govs){
  const segs = [];
  let start = 0;
  for(let i=1;i<govs.length;i++){
    if (govs[i] !== govs[i-1]){
      segs.push({ gov: govs[i-1], y0: years[start], y1: years[i-1] });
      start = i;
    }
  }
  segs.push({ gov: govs[govs.length-1], y0: years[start], y1: years[years.length-1] });

  // remove segs vazios
  const segs2 = segs.filter(s=>s.gov);

  // cor por ordem de apariÃ§Ã£o
  const govList = unique(segs2.map(s=>s.gov));
  const colorMap = {};
  govList.forEach((g,i)=> colorMap[g] = GOV_COLORS[i % GOV_COLORS.length]);
  segs2.forEach(s=> s.cor = colorMap[s.gov] || "#888");

  return segs2;
}

/* =========================
   RECORTE (DOWNLOAD)
========================= */
function getRecorteSlim(){
  const rows = getFilteredRows();
  const selVar = document.getElementById("selVariavel").value;
  const selLoc = document.getElementById("selLocalidade").value;
  const govCol = govColForLocalidade(selLoc);
  const tipoGov = tipoGovernoForLocalidade(selLoc);
  const dec = decimalsForCurrent(selVar);

  const out = [];
  rows.forEach(r=>{
    const ano = Math.trunc(r[COL_ANO]);
    const gov = normText(r[govCol]) || "";
    if (governoAtivo && gov !== governoAtivo) return;

    const v = parseNumber(r[selVar]);
    out.push({
      Ano: ano,
      Localidade: selLoc,
      Tipo_Governo: tipoGov,
      Governo: gov,
      Variavel: selVar,
      Valor_num: Number.isFinite(v) ? v : "",
      Valor_fmt: Number.isFinite(v) ? formatBR(v, dec) : "â€“"
    });
  });
  return out;
}

/* =========================
   RENDER
========================= */
function updateAll(){
  const status = document.getElementById("statusText");
  const ds = getDataset();

  if (!ds.length){
    status.textContent = `Sem dados carregados para a aba ${activeTab.toUpperCase()} (use /data/*.csv ou upload).`;
  } else {
    status.textContent = `OK â€¢ Aba: ${activeTab.toUpperCase()} â€¢ Clique em um governo para filtrar.`;
  }

  const rows = getFilteredRows();
  renderChartAndGovPanel(rows);
  renderGovTable(rows);
}

function renderChartAndGovPanel(rows){
  const selVar = document.getElementById("selVariavel").value;
  const selLoc = document.getElementById("selLocalidade").value;
  const dec = decimalsForCurrent(selVar);

  const { years, values, govs } = buildAnnualSeries(rows, selVar, selLoc);

  // filtro por governo clicado
  let xs = years.slice();
  let ys = values.slice();
  let gs = govs.slice();

  if (governoAtivo){
    xs = xs.filter((_,i)=> gs[i] === governoAtivo);
    ys = ys.filter((_,i)=> gs[i] === governoAtivo);
  }

  const mean = ys.filter(v=>Number.isFinite(v)).length
    ? ys.filter(v=>Number.isFinite(v)).reduce((a,b)=>a+b,0) / ys.filter(v=>Number.isFinite(v)).length
    : null;

  const trend = linearTrendXY(xs, ys);

  // barras no fundo (sempre baseado na sÃ©rie completa, nÃ£o na filtrada)
  const segs = buildGovSegments(years, govs);
  const segsVis = governoAtivo ? segs.filter(s=>s.gov===governoAtivo) : segs;

  const shapes = segsVis.map(s=>({
    type:"rect",
    xref:"x",
    yref:"paper",
    x0: s.y0 - 0.5,
    x1: s.y1 + 0.5,
    y0: 0,
    y1: 1,
    fillcolor: hexToRgba(s.cor, 0.22),
    line: { width: 0 },
    layer: "below"
  }));

  const traces = [];

  traces.push({
    x: xs,
    y: ys,
    mode: "lines+markers",
    name: "SÃ©rie",
    line: { color: "#1f77b4" },
    hovertemplate: `Ano=%{x}<br>Valor=%{y}<extra></extra>`
  });

  if (mean !== null){
    traces.push({
      x: xs,
      y: xs.map(()=>mean),
      mode: "lines",
      name: "MÃ©dia",
      line: { color: "#1f77b4", dash: "dot" },
      hovertemplate: `MÃ©dia=%{y}<extra></extra>`
    });
  }

  if (trend && trend.some(v=>v!==null)){
    traces.push({
      x: xs,
      y: trend,
      mode: "lines",
      name: "TendÃªncia",
      line: { color: "#d62728", dash: "dash" },
      hovertemplate: `TendÃªncia=%{y}<extra></extra>`
    });
  }

  const titulo = `${selLoc}: ${selVar}`.replace(": ", ":<br>");

  const minX = years.length ? Math.min(...years) : 2012;
  const maxX = years.length ? Math.max(...years) : 2024;

  Plotly.newPlot("grafico", traces, {
    title: { text: titulo, x: 0.5, xanchor: "center" },
    xaxis: {
      title: "Ano",
      type: "linear",
      tickmode: "linear",
      dtick: 1,
      tickformat: "d",
      range: [minX - 0.5, maxX + 0.5]
    },
    yaxis: { title: activeTab === "cv" ? "CV" : "Valor" },
    shapes: shapes,
    height: 560,
    margin: { l: 70, r: 20, t: 90, b: 80 },
    legend: { orientation: "v" }
  }, { displaylogo:false, responsive:true });

  // hover com formataÃ§Ã£o BR
  try{
    const fmt = (dec===0) ? ",.0f" : ",."+dec+"f";
    Plotly.restyle("grafico", { hovertemplate: [`Ano=%{x}<br>Valor=%{y:${fmt}}<extra></extra>`] }, [0]);
    if (mean !== null) Plotly.restyle("grafico", { hovertemplate: [`MÃ©dia=%{y:${fmt}}<extra></extra>`] }, [1]);
    if (trend && trend.some(v=>v!==null)){
      const idx = (mean!==null) ? 2 : 1;
      Plotly.restyle("grafico", { hovertemplate: [`TendÃªncia=%{y:${fmt}}<extra></extra>`] }, [idx]);
    }
  }catch(e){}

  renderGovPanel(segs);
}

function renderGovPanel(segs){
  const painel = document.getElementById("painel-governos");
  const btnReset = document.getElementById("reset-governo");
  painel.innerHTML = "";

  if (!segs.length){
    painel.innerHTML = `<div style="font-size:.8rem;color:#666;line-height:1.3;">
      Nenhum governante encontrado no CSV para este recorte.<br/>
      Verifique as colunas: Presidente_BR / Governador_RS / Prefeito_POA.
    </div>`;
    btnReset.style.display = "none";
    return;
  }

  // lista Ãºnica em ordem
  const govOrder = [];
  segs.forEach(s=>{ if (!govOrder.includes(s.gov)) govOrder.push(s.gov); });

  const colorByGov = {};
  segs.forEach(s=>{ if (!colorByGov[s.gov]) colorByGov[s.gov] = s.cor || "#888"; });

  govOrder.forEach(g=>{
    const segList = segs.filter(s=>s.gov===g);
    const ini = segList[0].y0;
    const fim = segList[segList.length-1].y1;

    const div = document.createElement("div");
    div.className = "gov-item" + (governoAtivo === g ? " ativo" : "");
    div.style.backgroundColor = colorByGov[g] || "#888";
    div.innerHTML = `<div>${g}</div><div class="gov-sub">${ini} â†’ ${fim}</div>`;

    div.addEventListener("click", ()=>{
      governoAtivo = (governoAtivo === g) ? null : g;
      updateAll();
    });

    painel.appendChild(div);
  });

  btnReset.style.display = governoAtivo ? "inline-block" : "none";
}

/* =========================
   TABELA POR GOVERNO
========================= */
function renderGovTable(rows){
  const tbody = document.querySelector("#tabela-estat tbody");
  tbody.innerHTML = "";

  const selVar = document.getElementById("selVariavel").value;
  const selLoc = document.getElementById("selLocalidade").value;
  const govCol = govColForLocalidade(selLoc);
  const dec = decimalsForCurrent(selVar);

  // agrupa por governo mantendo ordem de apariÃ§Ã£o
  const base = rows.slice().sort((a,b)=>a[COL_ANO]-b[COL_ANO]);
  const govOrder = [];
  base.forEach(r=>{
    const g = normText(r[govCol]) || "";
    if (g && !govOrder.includes(g)) govOrder.push(g);
  });

  const govList = governoAtivo ? govOrder.filter(g=>g===governoAtivo) : govOrder;

  const stats = [];
  govList.forEach(g=>{
    const subset = base.filter(r => normText(r[govCol]) === g);
    if (!subset.length) return;

    const anos = subset.map(r=>Math.trunc(r[COL_ANO])).filter(Number.isFinite);
    const ini = Math.min(...anos);
    const fim = Math.max(...anos);

    const values = subset.map(r=>parseNumber(r[selVar])).filter(Number.isFinite);
    if (!values.length) return;

    const mean = values.reduce((a,b)=>a+b,0)/values.length;
    const minv = Math.min(...values);
    const maxv = Math.max(...values);

    const varIntra = (minv !== 0) ? ((maxv - minv) / Math.abs(minv)) * 100 : NaN;

    stats.push({
      Governo: g,
      Inicio: ini,
      Fim: fim,
      N_anos: values.length,
      Media_num: mean,
      Minimo_num: minv,
      Maximo_num: maxv,
      Variacao_interna_pct_num: Number.isFinite(varIntra) ? varIntra : NaN
    });
  });

  for (let i=0;i<stats.length;i++){
    if (i===0){
      stats[i].Delta_media_vs_anterior_pct_num = NaN;
    } else {
      const prev = stats[i-1].Media_num;
      const cur  = stats[i].Media_num;
      stats[i].Delta_media_vs_anterior_pct_num = (prev !== 0) ? ((cur - prev) / Math.abs(prev)) * 100 : NaN;
    }
  }

  lastGovTable = stats.map(s=>({
    Governo: s.Governo,
    Inicio: s.Inicio,
    Fim: s.Fim,
    N_anos: s.N_anos,
    Media: formatBR(s.Media_num, dec),
    Minimo: formatBR(s.Minimo_num, dec),
    Maximo: formatBR(s.Maximo_num, dec),
    Variacao_interna_pct: Number.isFinite(s.Variacao_interna_pct_num) ? formatBR(s.Variacao_interna_pct_num, 1) + "%" : "â€“",
    Delta_media_vs_anterior_pct: Number.isFinite(s.Delta_media_vs_anterior_pct_num) ? formatBR(s.Delta_media_vs_anterior_pct_num, 1) + "%" : "â€“"
  }));

  lastGovTable.forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="font-weight:900;">${row.Governo}</td>
      <td>${row.Inicio}</td>
      <td>${row.Fim}</td>
      <td>${row.N_anos}</td>
      <td>${row.Media}</td>
      <td>${row.Minimo}</td>
      <td>${row.Maximo}</td>
      <td>${row.Variacao_interna_pct}</td>
      <td>${row.Delta_media_vs_anterior_pct}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================
   START
========================= */
(function setFooterDate(){
  const hoje = new Date();
  document.getElementById("data-atualizacao").textContent =
    "Atualizado em: " + hoje.toLocaleDateString("pt-BR");
})();
loadAllData();
</script>

</body>
</html>
